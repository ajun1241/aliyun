<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.modcreater.tmdao.mapper.EventMapper">

    <sql id="Base_Column_List">
        eventId,userId,eventName,startTime,endTime,address,level,flag,
        remarks,person,repeatTime,isOverdue,remindTime,day,month,year,type
    </sql>

    <insert id="uploadingEvents" parameterType="com.modcreater.tmbeans.pojo.SingleEvent">
            insert into singleevent values
            (null ,
            #{eventid} ,
            #{userid},
            #{eventname},
            #{starttime},
            #{endtime},
            #{address},
            #{level},
            #{flag},
            #{person},
            #{remarks},
            #{repeaTtime},
            #{isOverdue},
            #{remindTime},
            #{day},
            #{month},
            #{year},
            #{type})
    </insert>

    <select id="countIdByDate" resultType="java.lang.Integer">
        select count(id) from singleevent where
        (userId = #{userid} and day = #{day} and month = #{month} and year = #{year}) and
        ((startTime &gt; #{starttime} and endTime &lt; #{endtime}) or
        (startTime &gt;= #{starttime} and startTime &lt;= #{endtime}) or
        (endTime &gt;= #{starttime} and endTime &lt;= #{endtime}) or
        (startTime &lt;= #{starttime} and endTime &gt;= #{endtime}))
    </select>

    <insert id="uploadingLoopEvents" parameterType="com.modcreater.tmbeans.pojo.SingleEvent">
            insert into loopevent values
            (null ,
            #{eventid} ,
            #{userid},
            #{eventname},
            #{starttime},
            #{endtime},
            #{address},
            #{level},
            #{flag},
            #{person},
            #{remarks},
            #{repeaTtime},
            #{isOverdue},
            #{remindTime},
            #{day},
            #{month},
            #{year},
            #{type})
    </insert>

    <update id="withdrawEventsByUserId">
        update singleevent set isOverdue = #{isOverdue} where eventId = #{eventid} and userId = #{userid} and isOverdue &lt;&gt; 2
    </update>

    <update id="withdrawLoopEventsByUserId">
        update loopevent set isOverdue = #{isOverdue} where eventId = #{eventid} and userId = #{userid} and isOverdue &lt;&gt; 2
    </update>

    <update id="alterEventsByUserId">
            update singleevent set
                eventName = #{eventname},
                startTime = #{starttime},
                endTime = #{endtime},
                address = #{address},
                level = #{level},
                flag = #{flag},
                person = #{person},
                remarks = #{remarks},
                repeatTime = #{repeaTtime},
                isOverdue = #{isOverdue},
                remindTime = #{remindTime},
                day = #{day},
                month = #{month},
                year = #{year},
                type = #{type}
            where eventId = #{eventid} and userId = #{userid}
    </update>

    <update id="alterLoopEventsByUserId">
            update loopevent set
                eventName = #{eventname},
                startTime = #{starttime},
                endTime = #{endtime},
                address = #{address},
                level = #{level},
                flag = #{flag},
                person = #{person},
                remarks = #{remarks},
                repeatTime = #{repeaTtime},
                isOverdue = #{isOverdue},
                remindTime = #{remindTime},
                day = #{day},
                month = #{month},
                year = #{year},
                type = #{type}
            where eventId = #{eventid} and userId = #{userid}
    </update>
    <delete id="deleteEventsByUserId">
        delete from singleevent where eventId = #{eventid} and userId = #{userid}
    </delete>
    <delete id="deleteLoopEventsByUserId">
        delete from loopevent where eventId = #{eventid} and userId = #{userid}
    </delete>

    <select id="queryEvents" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select
        <include refid="Base_Column_List"/>
        from singleevent
        <where>
            <if test="userid != null">
                userid = #{userid}
            </if>
            <if test="day != null">
                and day = #{day}
            </if>
            <if test="month != null">
                and month = #{month}
            </if>
            <if test="year != null">
                and year = #{year}
            </if>
            and isOverdue &lt;&gt; 2
        </where>
        order by day asc ,startTime asc
    </select>

    <select id="queryByDayOrderByLevel" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select
        <include refid="Base_Column_List"/>
        from singleevent
        <where>
            <if test="userid != null">
                userid = #{userid}
            </if>
            <if test="day != null">
                and day = #{day}
            </if>
            <if test="month != null">
                and month = #{month}
            </if>
            <if test="year != null">
                and year = #{year}
            </if>
            and isOverdue &lt;&gt; 2
        </where>
        order by level asc
    </select>

    <select id="queryByDayOrderByLevelAndDate" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select
        <include refid="Base_Column_List"/>
        from singleevent
        <where>
            <if test="userid != null">
                userid = #{userid}
            </if>
            <if test="day != null">
                and day = #{day}
            </if>
            <if test="month != null">
                and month = #{month}
            </if>
            <if test="year != null">
                and year = #{year}
            </if>
            and isOverdue &lt;&gt; 2
        </where>
        order by level asc , startTime asc
    </select>
    <select id="queryByDayEventIdsInMonth" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select
        <include refid="Base_Column_List"/>
        from singleevent
        <where>
            <if test="userid != null">
                userid = #{userid}
            </if>
            <if test="month != null">
                and month = #{month}
            </if>
            <if test="year != null">
                and year = #{year}
            </if>
            and isOverdue &lt;&gt; 2
        </where>
        order by day asc
    </select>

    <update id="updOldEvent">
            update singleevent set
                isOverdue = 2
            where userId = #{userid} and year =#{year} and month=#{month} and day=#{day}
    </update>

    <select id="queryEventByUserId" resultType="int">
        select count(1) from singleevent where userId=#{userId}
    </select>

    <insert id="uplDraft" parameterType="com.modcreater.tmbeans.vo.eventvo.DraftVo">
        insert into draft values
        (null ,
        #{userId},
        #{phoneNum},
        #{data}
        )
    </insert>

    <select id="queryDraftByPhone" parameterType="String" resultType="String">
        select data from draft where phoneNum=#{phoneNum}
    </select>

    <select id="queryLoopEvents" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select
        <include refid="Base_Column_List"/>
        from loopevent
        where userid = #{userId} and isOverdue &lt;&gt; 2 order by startTime asc
    </select>
    <select id="queryByWeekOrderByStartTime" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select
        <include refid="Base_Column_List"/>
        from singleevent
        <where>
            <if test="userid != null">
                userid = #{userid}
            </if>
            <if test="day != null">
                and day = #{day}
            </if>
            <if test="month != null">
                and month = #{month}
            </if>
            <if test="year != null">
                and year = #{year}
            </if>
            and isOverdue &lt;&gt; 2
        </where>
        order by startTime asc
    </select>
    <select id="queryDays" resultType="java.lang.Integer">
        select day from singleevent where
        userId = #{userid}
        and month = #{month}
        and year = #{year}
        group by day
    </select>
    <select id="querySingleEvent" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select <include refid="Base_Column_List"/> from singleevent where userid=#{userid} and eventid = #{eventid} and isOverdue = 0
    </select>
    <select id="queryLoopSingleEvent" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select <include refid="Base_Column_List"/> from loopevent where userid=#{userid} and eventid = #{eventid} and isOverdue = 0
    </select>
    <select id="queryUserEventsByUserIdIsOverdue" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select eventId,userId,eventName,day,month,year
        from singleevent
        where userId = #{userId}
        and isOverdue = #{isOverdue}
        order by year desc,month desc,day desc limit 0,7
    </select>
    <select id="queryUserLoopEventsByUserIdIsOverdue" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select eventId,userId,eventName,repeatTime from singleevent where userId = #{userId} and isOverdue = #{isOverdue}
    </select>
    <select id="searchEventsByEventName" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select eventId,userId,eventName,day,month,year
        from singleevent
        where userId = #{userid}
        and isOverdue = #{isOverdue}
        and eventName like "%"#{eventname}"%"
        order by year desc,month desc,day desc
    </select>
    <select id="queryEventsByConditions" resultType="com.modcreater.tmbeans.pojo.SingleEvent">
        select eventId,userId,eventName,day,month,year
        from singleevent
        <where>
            <if test="type != null and type != ''">
                type = #{type}
            </if>
            <if test="level != null and level != ''">
                and level = #{level}
            </if>
            <if test="person != null and person != ''">
                and person = #{person}
            </if>
            <if test="year != null and year != ''">
                and year = #{year}
            </if>
            <if test="month != null and month != ''">
                and month = #{month}
            </if>
            <if test="day != null and day != ''">
                and day = #{day}
            </if>
            <if test="isOverdue != null">
                and isOverdue = #{isOverdue}
            </if>
        </where>
        and ((startTime &gt;= #{starttime} and startTime &lt;= #{endtime}) or
        (endTime &gt;= #{starttime} and endTime &lt;= #{endtime}) or
        (startTime &lt;= #{starttime} and endTime &gt;= #{endtime}) or
        (startTime &gt;= #{starttime} and endTime &lt;= #{endtime}))
        order by year desc,month desc,day desc
    </select>
    <select id="getUserEventsGroupByType" resultType="com.modcreater.tmbeans.databaseresult.GetUserEventsGroupByType">
        select type ,sum(endTime-startTime) totalMinutes ,count(type) num from singleevent
        where userId = #{userId} and (isOverdue = 0 or isOverdue = 1) group by type
    </select>
    <select id="getUserLoopEventsGroupByType" resultType="com.modcreater.tmbeans.databaseresult.GetUserEventsGroupByType">
        select type ,sum(endTime-startTime) totalMinutes ,count(type) num from loopevent
        where userId = #{userId} and (isOverdue = 0 or isOverdue = 1) group by type
    </select>
    <select id="getMaxSingleEventType" resultType="java.lang.Long">
        select max(endTime-startTime) from singleevent
        where userId = #{userId} and (isOverdue = 0 or isOverdue = 1)
    </select>
    <select id="getMaxLoopEventType" resultType="java.lang.Long">
        select max(endTime-startTime) from loopevent
        where userId = #{userId} and (isOverdue = 0 or isOverdue = 1)
    </select>
    <select id="getMinSingleEventType" resultType="java.lang.Long">
        select min(endTime-startTime) from singleevent
        where userId = #{userId} and (isOverdue = 0 or isOverdue = 1)
    </select>
    <select id="getMinLoopEventType" resultType="java.lang.Long">
        select min(endTime-startTime) from loopevent
        where userId = #{userId} and (isOverdue = 0 or isOverdue = 1)
    </select>

    <update id="updateDraft" parameterType="com.modcreater.tmbeans.vo.eventvo.DraftVo" >
        update draft set `data`=concat(`data`,#{data})
        where phoneNum=#{phoneNum}
    </update>
</mapper>